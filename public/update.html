<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Update Article</title>
    <!-- Include Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
      crossorigin="anonymous"
    />
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container">
          <!-- Brand/logo -->
          <a class="navbar-brand" href="/">Home</a>
          <!-- Toggler/collapsible Button -->
          <button
            class="navbar-toggler"
            type="button"
            data-bs-toggle="collapse"
            data-bs-target="#navbarNav"
            aria-controls="navbarNav"
            aria-expanded="false"
            aria-label="Toggle navigation"
          >
            <span class="navbar-toggler-icon"></span>
          </button>
          <!-- Navbar Links -->
          <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav">
              <li class="nav-item">
                <a class="nav-link" href="/create-form">Create</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="/update-form">Update</a>
              </li>
            </ul>
          </div>
        </div>
      </nav>
    <div class="container mt-5">
      <div class="row justify-content-center">
        <div class="col-md-8">
          <div class="card">
            <div class="card-header text-white bg-primary">
              <h2>Find By Id</h2>
            </div>
            <div class="card-body">
              <form id="articleForm">
                <!-- Form fields here -->
                <div class="form-group">
                  <label for="_id">Article Id:</label>
                  <input
                    type="text"
                    class="form-control"
                    id="_id"
                    name="_id"
                    value=""
                    required
                  />
                </div>
                <div id="inputContainer" class="form-group"></div>
                <!-- Add Bootstrap class "form-group" here -->

                <br />
                <button type="submit" class="btn btn-primary">Search</button>
              </form>
              <!-- Add an Update button with a unique ID -->
              <button id="updateButton" class="btn btn-primary" style="display: none;">Update</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const form = document.getElementById("articleForm"); // Get the form element by ID
      const inputContainer = document.getElementById("inputContainer"); // Get the input container element by ID
      const updateButton = document.getElementById("updateButton"); // Get the Update button element by ID

      form.addEventListener("submit", async function (e) {
        e.preventDefault();

        const searchFormData = {
          _id: document.getElementById("_id").value,
        };

        async function searchData(searchFormData) {
          try {
            console.log("Client-side JavaScript is running");

            const response = await fetch(`/fetchById/${searchFormData._id}`);

            if (response.ok) {
              const dbUser = await response.json();
              console.log("Data fetched successfully:", dbUser);
              // Clear the previous input fields if any
              inputContainer.innerHTML = "";

              // Loop through the key-value pairs in the JSON response
              for (const key in dbUser) {
                if (
                  dbUser.hasOwnProperty(key) &&
                  key !== "__v"
                ) {
                  const value = key === "content" ? dbUser[key] : dbUser[key];

                  // Create a Bootstrap form group
                  const formGroup = document.createElement("div");
                  formGroup.classList.add("form-group"); // Add Bootstrap class "form-group"

                  // Create a label element for the key
                  const label = document.createElement("label");
                  label.textContent = key;
                  formGroup.appendChild(label);

                  // Create an input field and set its value to the corresponding JSON value
                  const input = document.createElement("textarea");
                  if (key === "content") {
                    input.rows = 5; 
                  } else {
                    input.type = "text";
                  }
                  input.value = value;
                  input.classList.add("form-control"); 
                  formGroup.appendChild(input);

                  // Append the form group to the input container
                  inputContainer.appendChild(formGroup);
                }
              }
              // Change the "Search" button to an "Update" button
              const searchButton = document.querySelector(
                'button[type="submit"]'
              );
              searchButton.style.display = "none"; // Hide the Search button
              updateButton.style.display = "block"; // Show the Update button

              // Add an event listener for the "Update" button
              updateButton.addEventListener("click", async function () {
                // Create an object to store the updated data
                const updatedData = {};

                // Loop through the form fields and get updated values
                const formGroups = inputContainer.querySelectorAll(".form-group");
                formGroups.forEach((formGroup) => {
                  const label = formGroup.querySelector("label");
                  const input = formGroup.querySelector("input, textarea");
                  updatedData[label.textContent] = input.value;
                });

                // Send the updated data to the server for processing
                const response = await fetch("/update", {
                  method: "PUT",
                  headers: {
                    "Content-Type": "application/json",
                  },
                  body: JSON.stringify(updatedData),
                });

                if (response.ok) {
                  const updatedUser = await response.json();
                  console.log("Data updated successfully:", updatedUser);
                } else {
                  throw new Error("Failed to update data");
                }
              });
            } else {
              throw new Error("Failed to submit data");
            }
          } catch (error) {
            console.error(error);
          }
        }

        // Call the searchFormData function with formData
        await searchData(searchFormData);
      });
    </script>
  </body>
</html>
